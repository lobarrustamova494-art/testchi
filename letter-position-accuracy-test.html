<!DOCTYPE html>
<html>
<head>
    <title>Letter Position Accuracy Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .container { 
            text-align: center; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin: 20px 0; 
        }
        .accuracy-focus {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .letter-sequence {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .letter-circle {
            width: 60px;
            height: 60px;
            border: 3px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            position: relative;
        }
        .position-number {
            position: absolute;
            top: -30px;
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }
        .letter-name {
            position: absolute;
            bottom: -30px;
            font-size: 14px;
            color: #000;
            font-weight: bold;
        }
        .marked { background-color: #000; color: white; }
        .empty { background-color: white; color: #000; }
        
        .test-scenarios {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .scenario {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .scenario-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        .expected-answer {
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
        }
        
        button { 
            padding: 12px 24px; 
            margin: 10px; 
            font-size: 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .primary { background-color: #ffc107; color: #000; }
        .success { background-color: #28a745; color: white; }
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .match { background: #d4edda; }
        .mismatch { background: #f8d7da; }
        .critical-error { background: #f5c6cb; border: 2px solid #dc3545; }
    </style>
</head>
<body>
    <h1>üéØ Letter Position Accuracy Test</h1>
    <p>Bu test AI ning rasmdagi harf pozitsiyalarini to'g'ri tanish va mapping qilish aniqligini tekshiradi</p>
    
    <div class="accuracy-focus">
        <h2>üéØ Asosiy Muammo</h2>
        <p><strong>AI rasmdagi harf pozitsiyalarini noto'g'ri o'qiyapti!</strong></p>
        <p>AI quyidagilarni aniq tanishi kerak:</p>
        <ul>
            <li>‚úÖ Har bir aylanada qaysi harf yozilgan (A, B, C, D, E)</li>
            <li>‚úÖ Harflar qanday navbatda joylashgan (chapdan o'ngga)</li>
            <li>‚úÖ Qaysi harfning aylanasi belgilangan</li>
            <li>‚úÖ Belgilangan aylanadagi harfni to'g'ri aniqlash</li>
        </ul>
    </div>

    <div class="container">
        <h2>Standard Letter Sequence</h2>
        <p>Har bir savol qatorida harflar DOIMO shu tartibda bo'lishi kerak:</p>
        
        <div class="letter-sequence">
            <div class="letter-circle empty">
                <div class="position-number">Pos 1</div>
                <div class="letter-name">LEFTMOST</div>
                A
            </div>
            <div class="letter-circle empty">
                <div class="position-number">Pos 2</div>
                <div class="letter-name">SECOND</div>
                B
            </div>
            <div class="letter-circle empty">
                <div class="position-number">Pos 3</div>
                <div class="letter-name">MIDDLE</div>
                C
            </div>
            <div class="letter-circle empty">
                <div class="position-number">Pos 4</div>
                <div class="letter-name">FOURTH</div>
                D
            </div>
            <div class="letter-circle empty">
                <div class="position-number">Pos 5</div>
                <div class="letter-name">RIGHTMOST</div>
                E
            </div>
        </div>
        
        <p><strong>CRITICAL:</strong> AI avval aylanalar ichidagi harflarni o'qishi, keyin belgilarni aniqlashi kerak!</p>
    </div>

    <div class="container">
        <h2>Test Scenarios</h2>
        
        <div class="test-scenarios">
            <div class="scenario">
                <div class="scenario-title">Scenario 1: A marked</div>
                <div class="letter-sequence">
                    <div class="letter-circle marked">A</div>
                    <div class="letter-circle empty">B</div>
                    <div class="letter-circle empty">C</div>
                    <div class="letter-circle empty">D</div>
                    <div class="letter-circle empty">E</div>
                </div>
                <div class="expected-answer">Expected: A (leftmost circle marked)</div>
            </div>
            
            <div class="scenario">
                <div class="scenario-title">Scenario 2: C marked</div>
                <div class="letter-sequence">
                    <div class="letter-circle empty">A</div>
                    <div class="letter-circle empty">B</div>
                    <div class="letter-circle marked">C</div>
                    <div class="letter-circle empty">D</div>
                    <div class="letter-circle empty">E</div>
                </div>
                <div class="expected-answer">Expected: C (middle circle marked)</div>
            </div>
            
            <div class="scenario">
                <div class="scenario-title">Scenario 3: E marked</div>
                <div class="letter-sequence">
                    <div class="letter-circle empty">A</div>
                    <div class="letter-circle empty">B</div>
                    <div class="letter-circle empty">C</div>
                    <div class="letter-circle empty">D</div>
                    <div class="letter-circle marked">E</div>
                </div>
                <div class="expected-answer">Expected: E (rightmost circle marked)</div>
            </div>
            
            <div class="scenario">
                <div class="scenario-title">Scenario 4: B marked</div>
                <div class="letter-sequence">
                    <div class="letter-circle empty">A</div>
                    <div class="letter-circle marked">B</div>
                    <div class="letter-circle empty">C</div>
                    <div class="letter-circle empty">D</div>
                    <div class="letter-circle empty">E</div>
                </div>
                <div class="expected-answer">Expected: B (second circle marked)</div>
            </div>
            
            <div class="scenario">
                <div class="scenario-title">Scenario 5: D marked</div>
                <div class="letter-sequence">
                    <div class="letter-circle empty">A</div>
                    <div class="letter-circle empty">B</div>
                    <div class="letter-circle empty">C</div>
                    <div class="letter-circle marked">D</div>
                    <div class="letter-circle empty">E</div>
                </div>
                <div class="expected-answer">Expected: D (fourth circle marked)</div>
            </div>
            
            <div class="scenario">
                <div class="scenario-title">Scenario 6: No marks</div>
                <div class="letter-sequence">
                    <div class="letter-circle empty">A</div>
                    <div class="letter-circle empty">B</div>
                    <div class="letter-circle empty">C</div>
                    <div class="letter-circle empty">D</div>
                    <div class="letter-circle empty">E</div>
                </div>
                <div class="expected-answer">Expected: BLANK (no circles marked)</div>
            </div>
        </div>
    </div>

    <div class="container">
        <button class="primary" onclick="testLetterPositionAccuracy()">üéØ Letter Position Accuracy Test</button>
        <button class="success" onclick="testAllLetterPositions()">üìç All Letter Positions Test</button>
    </div>

    <div id="results" class="results" style="display: none;">
        <h3>üìä Test Natijalari</h3>
        <div id="results-content"></div>
    </div>

    <script>
        function createLetterPositionTestImage(scenarios) {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 700;
            const ctx = canvas.getContext('2d');
            
            // Fill white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw title
            ctx.fillStyle = 'black';
            ctx.font = 'bold 18px Arial';
            ctx.fillText('Letter Position Accuracy Test', 50, 40);
            
            // Draw instructions
            ctx.font = '14px Arial';
            ctx.fillText('Each row has 5 circles with letters A, B, C, D, E (left to right)', 50, 65);
            
            // Draw questions with letter position scenarios
            for (let i = 0; i < scenarios.length; i++) {
                const y = 120 + i * 90;
                
                // Draw question number
                ctx.font = 'bold 16px Arial';
                ctx.fillText(`${i + 1}.`, 50, y);
                
                // Draw 5 circles for each question with clear letters
                for (let j = 0; j < 5; j++) {
                    const x = 100 + j * 100;
                    const letter = String.fromCharCode(65 + j); // A, B, C, D, E
                    
                    // Draw circle
                    ctx.beginPath();
                    ctx.arc(x, y - 10, 25, 0, 2 * Math.PI);
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Apply marking based on scenario
                    const scenario = scenarios[i];
                    if (j === scenario.markedPosition) {
                        // Fill the marked circle
                        ctx.fillStyle = 'black';
                        ctx.fill();
                        
                        // Draw letter in white on black background
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 20px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(letter, x, y - 5);
                    } else {
                        // Draw letter in black on white background
                        ctx.fillStyle = 'black';
                        ctx.font = 'bold 20px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(letter, x, y - 5);
                    }
                    
                    // Draw position labels
                    ctx.fillStyle = 'gray';
                    ctx.font = '10px Arial';
                    ctx.fillText(`Pos${j+1}`, x, y + 40);
                    ctx.fillText(letter, x, y + 55);
                }
                
                // Reset text alignment
                ctx.textAlign = 'left';
                ctx.fillStyle = 'black';
            }
            
            return canvas.toDataURL('image/png');
        }

        async function testLetterPositionAccuracy() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '<div style="text-align: center;">üéØ Letter Position Accuracy Test ishlamoqda...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Token topilmadi. Avval login qiling: http://localhost:5173');
                }
                
                // Test scenarios for letter position accuracy
                const scenarios = [
                    { markedPosition: 0, expectedAnswer: 'A', description: 'A marked (leftmost)' },
                    { markedPosition: 2, expectedAnswer: 'C', description: 'C marked (middle)' },
                    { markedPosition: 4, expectedAnswer: 'E', description: 'E marked (rightmost)' },
                    { markedPosition: 1, expectedAnswer: 'B', description: 'B marked (second)' },
                    { markedPosition: 3, expectedAnswer: 'D', description: 'D marked (fourth)' },
                    { markedPosition: -1, expectedAnswer: 'BLANK', description: 'No marks (blank)' }
                ];
                
                const answerKey = ['A', 'C', 'E', 'B', 'D', 'A']; // Expected answers
                
                const imageData = createLetterPositionTestImage(scenarios);
                
                const response = await fetch('http://localhost:5000/api/ai/analyze-omr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        image: imageData.split(',')[1],
                        answerKey: answerKey,
                        scoring: { correct: 1, wrong: 0, blank: 0 }
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message);
                }
                
                const aiAnswers = result.data.extractedAnswers;
                let correctDetections = 0;
                let criticalErrors = 0;
                let detailedResults = '';
                
                for (let i = 0; i < 6; i++) {
                    const scenario = scenarios[i];
                    const expected = scenario.expectedAnswer;
                    const actual = aiAnswers[i] || 'BLANK';
                    const isCorrect = actual === expected;
                    
                    if (isCorrect) {
                        correctDetections++;
                    } else {
                        criticalErrors++;
                    }
                    
                    const cssClass = isCorrect ? 'match' : (expected !== 'BLANK' ? 'critical-error' : 'mismatch');
                    
                    detailedResults += `
                        <div class="test-case ${cssClass}">
                            <strong>Q${i+1} (${scenario.description}):</strong>
                            <span style="color: #28a745; font-weight: bold;">Expected: ${expected}</span> | 
                            <span style="color: #007bff; font-weight: bold;">AI: ${actual}</span>
                            ${isCorrect ? '‚úÖ' : '‚ùå'}
                            ${!isCorrect && expected !== 'BLANK' ? '<br><strong style="color: #dc3545;">CRITICAL: Letter position mapping error!</strong>' : ''}
                        </div>
                    `;
                }
                
                const accuracy = (correctDetections / 6) * 100;
                
                resultsContent.innerHTML = `
                    <h3>üéØ Letter Position Accuracy Results</h3>
                    <div class="test-case ${criticalErrors === 0 ? 'match' : 'critical-error'}">
                        <h4>Overall Performance</h4>
                        <p><strong>Letter Position Accuracy:</strong> ${accuracy}% (${correctDetections}/6)</p>
                        <p><strong>Critical Errors:</strong> ${criticalErrors} (letter position mapping failures)</p>
                        <p><strong>AI Confidence:</strong> ${Math.round(result.data.confidence * 100)}%</p>
                        <p><strong>Status:</strong> ${criticalErrors === 0 ? '‚úÖ Perfect Letter Recognition' : '‚ùå Letter Position Mapping Issues'}</p>
                    </div>
                    <div class="accuracy-focus">
                        <h4>üéØ Letter Position Analysis</h4>
                        <p><strong>Critical Issue:</strong> AI must read the actual letters inside circles, not assume positions</p>
                        <p><strong>Required Process:</strong></p>
                        <ol>
                            <li>Read letters in circles from left to right</li>
                            <li>Verify sequence: A, B, C, D, E</li>
                            <li>Identify which letter's circle is marked</li>
                            <li>Report the letter of the marked circle</li>
                        </ol>
                    </div>
                    ${detailedResults}
                `;
                
            } catch (error) {
                console.error('Letter position accuracy test error:', error);
                resultsContent.innerHTML = `<div class="test-case critical-error">‚ùå Test xatosi: ${error.message}</div>`;
            }
        }

        async function testAllLetterPositions() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '<div style="text-align: center;">üìç All Letter Positions Test ishlamoqda...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Token topilmadi. Avval login qiling: http://localhost:5173');
                }
                
                // Test each letter position individually
                const letters = ['A', 'B', 'C', 'D', 'E'];
                let allResults = '';
                let totalCorrect = 0;
                let totalTests = 0;
                
                for (let pos = 0; pos < 5; pos++) {
                    const letter = letters[pos];
                    const scenarios = [{ markedPosition: pos, expectedAnswer: letter, description: `${letter} marked` }];
                    const answerKey = [letter];
                    
                    const imageData = createLetterPositionTestImage(scenarios);
                    
                    const response = await fetch('http://localhost:5000/api/ai/analyze-omr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            image: imageData.split(',')[1],
                            answerKey: answerKey,
                            scoring: { correct: 1, wrong: 0, blank: 0 }
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const aiAnswer = result.data.extractedAnswers[0] || 'BLANK';
                        const isCorrect = aiAnswer === letter;
                        
                        if (isCorrect) totalCorrect++;
                        totalTests++;
                        
                        allResults += `
                            <div class="test-case ${isCorrect ? 'match' : 'critical-error'}">
                                <strong>Position ${pos + 1} (${letter}) Test:</strong>
                                Expected: <strong>${letter}</strong> | AI: <strong>${aiAnswer}</strong>
                                ${isCorrect ? '‚úÖ' : '‚ùå'}
                                ${!isCorrect ? '<br><strong style="color: #dc3545;">CRITICAL: Failed to recognize letter ' + letter + ' in position ' + (pos + 1) + '</strong>' : ''}
                            </div>
                        `;
                    }
                    
                    // Small delay between tests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                const overallAccuracy = (totalCorrect / totalTests) * 100;
                
                resultsContent.innerHTML = `
                    <h3>üìç All Letter Positions Test Results</h3>
                    <div class="test-case ${totalCorrect === totalTests ? 'match' : 'critical-error'}">
                        <h4>Overall Performance</h4>
                        <p><strong>Overall Accuracy:</strong> ${overallAccuracy}% (${totalCorrect}/${totalTests})</p>
                        <p><strong>Status:</strong> ${totalCorrect === totalTests ? '‚úÖ All letter positions recognized correctly' : '‚ùå Some letter positions failed'}</p>
                    </div>
                    <div class="accuracy-focus">
                        <h4>üéØ Individual Letter Position Results</h4>
                        <p>Each letter should be recognized when marked in its correct position:</p>
                    </div>
                    ${allResults}
                `;
                
            } catch (error) {
                console.error('All letter positions test error:', error);
                resultsContent.innerHTML = `<div class="test-case critical-error">‚ùå Test xatosi: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>