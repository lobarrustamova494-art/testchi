<!DOCTYPE html>
<html>
<head>
    <title>Position Mapping Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .container { 
            text-align: center; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin: 20px 0; 
        }
        .position-demo {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 20px;
        }
        .question-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .question-number {
            font-weight: bold;
            font-size: 18px;
            width: 30px;
        }
        .circles-container {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .circle {
            width: 40px;
            height: 40px;
            border: 2px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            position: relative;
        }
        .position-label {
            position: absolute;
            top: -25px;
            font-size: 12px;
            color: #666;
        }
        .letter-label {
            position: absolute;
            bottom: -25px;
            font-size: 14px;
            color: #000;
            font-weight: bold;
        }
        .filled { background-color: #000; color: white; }
        .empty { background-color: white; color: #000; }
        .highlight { border-color: #007bff; border-width: 3px; }
        button { 
            padding: 12px 24px; 
            margin: 10px; 
            font-size: 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .primary { background-color: #007bff; color: white; }
        .success { background-color: #28a745; color: white; }
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .correct { background: #d4edda; border-color: #28a745; }
        .incorrect { background: #f8d7da; border-color: #dc3545; }
        .mapping-table {
            margin: 20px 0;
            border-collapse: collapse;
            width: 100%;
        }
        .mapping-table th, .mapping-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .mapping-table th {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üìç Position Mapping Test</h1>
    <p>Bu test AI ning har bir pozitsiyada qaysi harfni to'g'ri aniqlashini tekshiradi</p>
    
    <div class="container">
        <h2>Position Mapping Qoidalari</h2>
        <div class="position-demo">
            <div class="question-number">Q:</div>
            <div class="circles-container">
                <div class="circle empty">
                    <div class="position-label">Pos 1</div>
                    <div class="letter-label">A</div>
                    A
                </div>
                <div class="circle empty">
                    <div class="position-label">Pos 2</div>
                    <div class="letter-label">B</div>
                    B
                </div>
                <div class="circle empty">
                    <div class="position-label">Pos 3</div>
                    <div class="letter-label">C</div>
                    C
                </div>
                <div class="circle empty">
                    <div class="position-label">Pos 4</div>
                    <div class="letter-label">D</div>
                    D
                </div>
                <div class="circle empty">
                    <div class="position-label">Pos 5</div>
                    <div class="letter-label">E</div>
                    E
                </div>
            </div>
        </div>
        
        <table class="mapping-table">
            <tr>
                <th>Position</th>
                <th>1 (Leftmost)</th>
                <th>2 (Second)</th>
                <th>3 (Middle)</th>
                <th>4 (Fourth)</th>
                <th>5 (Rightmost)</th>
            </tr>
            <tr>
                <td><strong>Letter</strong></td>
                <td><strong>A</strong></td>
                <td><strong>B</strong></td>
                <td><strong>C</strong></td>
                <td><strong>D</strong></td>
                <td><strong>E</strong></td>
            </tr>
        </table>
    </div>

    <div class="container">
        <h2>Test Misollari</h2>
        
        <div class="question-row">
            <div class="question-number">1.</div>
            <div class="circles-container">
                <div class="circle filled highlight">A</div>
                <div class="circle empty">B</div>
                <div class="circle empty">C</div>
                <div class="circle empty">D</div>
                <div class="circle empty">E</div>
            </div>
            <div style="margin-left: 20px;">
                <strong>Kutilgan javob: A</strong><br>
                <small>Position 1 (leftmost) belgilangan</small>
            </div>
        </div>
        
        <div class="question-row">
            <div class="question-number">2.</div>
            <div class="circles-container">
                <div class="circle empty">A</div>
                <div class="circle empty">B</div>
                <div class="circle filled highlight">C</div>
                <div class="circle empty">D</div>
                <div class="circle empty">E</div>
            </div>
            <div style="margin-left: 20px;">
                <strong>Kutilgan javob: C</strong><br>
                <small>Position 3 (middle) belgilangan</small>
            </div>
        </div>
        
        <div class="question-row">
            <div class="question-number">3.</div>
            <div class="circles-container">
                <div class="circle empty">A</div>
                <div class="circle empty">B</div>
                <div class="circle empty">C</div>
                <div class="circle empty">D</div>
                <div class="circle filled highlight">E</div>
            </div>
            <div style="margin-left: 20px;">
                <strong>Kutilgan javob: E</strong><br>
                <small>Position 5 (rightmost) belgilangan</small>
            </div>
        </div>
        
        <div class="question-row">
            <div class="question-number">4.</div>
            <div class="circles-container">
                <div class="circle empty">A</div>
                <div class="circle filled highlight">B</div>
                <div class="circle empty">C</div>
                <div class="circle empty">D</div>
                <div class="circle empty">E</div>
            </div>
            <div style="margin-left: 20px;">
                <strong>Kutilgan javob: B</strong><br>
                <small>Position 2 (second) belgilangan</small>
            </div>
        </div>
        
        <div class="question-row">
            <div class="question-number">5.</div>
            <div class="circles-container">
                <div class="circle empty">A</div>
                <div class="circle empty">B</div>
                <div class="circle empty">C</div>
                <div class="circle filled highlight">D</div>
                <div class="circle empty">E</div>
            </div>
            <div style="margin-left: 20px;">
                <strong>Kutilgan javob: D</strong><br>
                <small>Position 4 (fourth) belgilangan</small>
            </div>
        </div>
    </div>

    <div class="container">
        <button class="primary" onclick="testPositionMapping()">üß™ Position Mapping Test</button>
        <button class="success" onclick="testAllPositions()">üìç Barcha Pozitsiyalarni Test</button>
    </div>

    <div id="results" class="results" style="display: none;">
        <h3>üìä Test Natijalari</h3>
        <div id="results-content"></div>
    </div>

    <script>
        function createPositionTestImage(positions) {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // Fill white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw title
            ctx.fillStyle = 'black';
            ctx.font = '16px Arial';
            ctx.fillText('Position Mapping Test', 50, 50);
            
            // Draw 5 questions with specific position markings
            for (let i = 0; i < 5; i++) {
                const y = 100 + i * 80;
                ctx.fillText(`${i + 1}.`, 50, y);
                
                // Draw 5 circles for each question
                for (let j = 0; j < 5; j++) {
                    const x = 100 + j * 80;
                    const letter = String.fromCharCode(65 + j); // A, B, C, D, E
                    
                    // Draw circle
                    ctx.beginPath();
                    ctx.arc(x, y - 5, 20, 0, 2 * Math.PI);
                    ctx.stroke();
                    
                    // Fill circle if it matches the expected position
                    if (j === positions[i]) {
                        ctx.fillStyle = 'black';
                        ctx.fill();
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 16px Arial';
                        ctx.fillText(letter, x - 6, y);
                        ctx.fillStyle = 'black';
                        ctx.font = '16px Arial';
                    } else {
                        ctx.fillText(letter, x - 6, y);
                    }
                }
            }
            
            return canvas.toDataURL('image/png');
        }

        async function testPositionMapping() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '<div style="text-align: center;">üß™ Position Mapping Test ishlamoqda...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Token topilmadi. Avval login qiling: http://localhost:5173');
                }
                
                // Test specific positions: A(0), C(2), E(4), B(1), D(3)
                const testPositions = [0, 2, 4, 1, 3]; // Positions to mark
                const expectedAnswers = ['A', 'C', 'E', 'B', 'D']; // Expected results
                const answerKey = ['A', 'A', 'A', 'A', 'A']; // Dummy answer key
                
                const imageData = createPositionTestImage(testPositions);
                
                const response = await fetch('http://localhost:5000/api/ai/analyze-omr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        image: imageData.split(',')[1],
                        answerKey: answerKey,
                        scoring: { correct: 1, wrong: 0, blank: 0 }
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message);
                }
                
                const aiAnswers = result.data.extractedAnswers;
                let correctMappings = 0;
                let detailedResults = '';
                
                for (let i = 0; i < 5; i++) {
                    const expected = expectedAnswers[i];
                    const actual = aiAnswers[i] || 'BLANK';
                    const isCorrect = actual === expected;
                    const position = testPositions[i] + 1;
                    
                    if (isCorrect) correctMappings++;
                    
                    detailedResults += `
                        <div class="test-case ${isCorrect ? 'correct' : 'incorrect'}">
                            <strong>Q${i+1}:</strong>
                            Position ${position} marked ‚Üí Expected: <strong>${expected}</strong> | AI: <strong>${actual}</strong>
                            ${isCorrect ? '‚úÖ To\'g\'ri' : '‚ùå Noto\'g\'ri'}
                        </div>
                    `;
                }
                
                const accuracy = (correctMappings / 5) * 100;
                
                resultsContent.innerHTML = `
                    <h3>üìç Position Mapping Results</h3>
                    <div class="test-case">
                        <h4>Overall Performance</h4>
                        <p><strong>Position Mapping Accuracy:</strong> ${accuracy}% (${correctMappings}/5)</p>
                        <p><strong>AI Confidence:</strong> ${Math.round(result.data.confidence * 100)}%</p>
                        <p><strong>Status:</strong> ${accuracy >= 80 ? '‚úÖ Yaxshi' : '‚ùå Yaxshilash kerak'}</p>
                    </div>
                    <h4>Detailed Position Analysis:</h4>
                    ${detailedResults}
                    <div class="test-case">
                        <h4>üìã Position Mapping Rules</h4>
                        <p><strong>Position 1 (Leftmost):</strong> A</p>
                        <p><strong>Position 2 (Second):</strong> B</p>
                        <p><strong>Position 3 (Middle):</strong> C</p>
                        <p><strong>Position 4 (Fourth):</strong> D</p>
                        <p><strong>Position 5 (Rightmost):</strong> E</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Position mapping test error:', error);
                resultsContent.innerHTML = `<div class="test-case incorrect">‚ùå Test xatosi: ${error.message}</div>`;
            }
        }

        async function testAllPositions() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '<div style="text-align: center;">üìç Barcha pozitsiyalar test qilinmoqda...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Token topilmadi. Avval login qiling: http://localhost:5173');
                }
                
                let allResults = '';
                let totalCorrect = 0;
                let totalTests = 0;
                
                // Test each position separately
                for (let pos = 0; pos < 5; pos++) {
                    const letter = String.fromCharCode(65 + pos); // A, B, C, D, E
                    const testPositions = [pos]; // Only mark this position
                    const expectedAnswers = [letter];
                    const answerKey = ['A']; // Single question
                    
                    const imageData = createPositionTestImage(testPositions);
                    
                    const response = await fetch('http://localhost:5000/api/ai/analyze-omr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            image: imageData.split(',')[1],
                            answerKey: answerKey,
                            scoring: { correct: 1, wrong: 0, blank: 0 }
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const aiAnswer = result.data.extractedAnswers[0] || 'BLANK';
                        const isCorrect = aiAnswer === letter;
                        
                        if (isCorrect) totalCorrect++;
                        totalTests++;
                        
                        allResults += `
                            <div class="test-case ${isCorrect ? 'correct' : 'incorrect'}">
                                <strong>Position ${pos + 1} Test:</strong>
                                Expected: <strong>${letter}</strong> | AI: <strong>${aiAnswer}</strong>
                                ${isCorrect ? '‚úÖ To\'g\'ri' : '‚ùå Noto\'g\'ri'}
                            </div>
                        `;
                    }
                    
                    // Small delay between tests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                const overallAccuracy = (totalCorrect / totalTests) * 100;
                
                resultsContent.innerHTML = `
                    <h3>üìç All Positions Test Results</h3>
                    <div class="test-case">
                        <h4>Overall Performance</h4>
                        <p><strong>Overall Accuracy:</strong> ${overallAccuracy}% (${totalCorrect}/${totalTests})</p>
                        <p><strong>Status:</strong> ${overallAccuracy >= 80 ? '‚úÖ Barcha pozitsiyalar to\'g\'ri' : '‚ùå Ba\'zi pozitsiyalar noto\'g\'ri'}</p>
                    </div>
                    ${allResults}
                `;
                
            } catch (error) {
                console.error('All positions test error:', error);
                resultsContent.innerHTML = `<div class="test-case incorrect">‚ùå Test xatosi: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>