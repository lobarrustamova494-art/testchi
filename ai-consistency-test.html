<!DOCTYPE html>
<html>
<head>
    <title>AI Consistency Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .container { 
            text-align: center; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin: 20px 0; 
        }
        button { 
            padding: 12px 24px; 
            margin: 10px; 
            font-size: 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .primary { background-color: #007bff; color: white; }
        .success { background-color: #28a745; color: white; }
        .danger { background-color: #dc3545; color: white; }
        .warning { background-color: #ffc107; color: black; }
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .consistent { border-left-color: #28a745; background: #d4edda; }
        .inconsistent { border-left-color: #dc3545; background: #f8d7da; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .comparison {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
        }
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin: 10px 0;
        }
        .answer-cell {
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        .match { background: #d4edda; }
        .mismatch { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>ü§ñ AI Consistency Test</h1>
    <p>Bu test AI tizimining bir xil rasm uchun har doim bir xil natija berishini tekshiradi</p>
    
    <div class="container">
        <h2>Test Parametrlari</h2>
        <p><strong>Test soni:</strong> <span id="test-count">5</span> marta</p>
        <p><strong>Kutilgan natija:</strong> Barcha testlar bir xil natija berishi kerak</p>
        
        <input type="range" id="test-count-slider" min="3" max="10" value="5" onchange="updateTestCount(this.value)">
        <label for="test-count-slider">Test soni: 3-10</label>
    </div>

    <div class="container">
        <button class="primary" onclick="runConsistencyTest()">üß™ Consistency Test Boshlash</button>
        <button class="success" onclick="runAccuracyTest()">üéØ Accuracy Test Boshlash</button>
        <button class="warning" onclick="clearResults()">üóëÔ∏è Natijalarni Tozalash</button>
    </div>

    <div id="results" class="results" style="display: none;">
        <h3>üìä Test Natijalari</h3>
        <div id="results-content"></div>
    </div>

    <script>
        let testResults = [];
        
        // Real test data from the images
        const realAnswerKey = [
            'A', 'A', 'A', 'B', 'B', 'B', 'C', 'C', 'C', 'D',  // 1-10
            'D', 'D', 'A', 'A', 'A', 'B', 'B', 'B', 'C', 'C'   // 11-20
        ];
        
        const expectedStudentAnswers = [
            'A', 'A', 'BLANK', 'BLANK', 'BLANK', 'BLANK', 'G', 'H',        // 1-8
            'A', 'BLANK', 'BLANK', 'D', 'BLANK', 'D', 'BLANK', 'H',        // 9-16
            'D', 'A', 'BLANK', 'D'                                         // 17-20
        ];

        function updateTestCount(value) {
            document.getElementById('test-count').textContent = value;
        }

        function createTestImage() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 1000;
            const ctx = canvas.getContext('2d');
            
            // Fill white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw OMR-like structure
            ctx.fillStyle = 'black';
            ctx.font = '16px Arial';
            ctx.fillText('OMR Test Sheet - Consistency Test', 50, 50);
            
            // Draw questions and simulate the expected student answers
            for (let i = 0; i < 20; i++) {
                const y = 100 + i * 40;
                ctx.fillText(`${i + 1}.`, 50, y);
                
                // Draw circles for options A, B, C, D, E
                for (let j = 0; j < 5; j++) {
                    const x = 100 + j * 60;
                    const letter = String.fromCharCode(65 + j); // A, B, C, D, E
                    
                    // Draw circle
                    ctx.beginPath();
                    ctx.arc(x, y - 5, 12, 0, 2 * Math.PI);
                    ctx.stroke();
                    
                    // Fill circle based on expected student answers
                    const studentAns = expectedStudentAnswers[i];
                    if (studentAns === letter) {
                        ctx.fillStyle = 'black';
                        ctx.fill();
                        ctx.fillStyle = 'white';
                        ctx.fillText(letter, x - 4, y);
                        ctx.fillStyle = 'black';
                    } else {
                        ctx.fillText(letter, x - 4, y);
                    }
                }
            }
            
            return canvas.toDataURL('image/png');
        }

        async function runSingleAITest(testNumber) {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('Token topilmadi. Avval login qiling: http://localhost:5173');
            }
            
            const imageData = createTestImage();
            
            const response = await fetch('http://localhost:5000/api/ai/analyze-omr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    image: imageData.split(',')[1],
                    answerKey: realAnswerKey,
                    scoring: { correct: 1, wrong: 0, blank: 0 }
                })
            });
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }
            
            return {
                testNumber,
                extractedAnswers: result.data.extractedAnswers,
                correctAnswers: result.data.correctAnswers,
                wrongAnswers: result.data.wrongAnswers,
                blankAnswers: result.data.blankAnswers,
                totalScore: result.data.totalScore,
                confidence: result.data.confidence,
                timestamp: new Date().toISOString()
            };
        }

        async function runConsistencyTest() {
            const testCount = parseInt(document.getElementById('test-count-slider').value);
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '<div style="text-align: center;">ü§ñ AI Consistency Test ishlamoqda...</div>';
            resultsDiv.style.display = 'block';
            
            testResults = [];
            
            try {
                // Run multiple tests
                for (let i = 1; i <= testCount; i++) {
                    resultsContent.innerHTML = `<div style="text-align: center;">ü§ñ Test ${i}/${testCount} ishlamoqda...</div>`;
                    
                    const result = await runSingleAITest(i);
                    testResults.push(result);
                    
                    // Small delay between tests
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // Analyze consistency
                analyzeConsistency();
                
            } catch (error) {
                console.error('Consistency test error:', error);
                resultsContent.innerHTML = `<div class="test-result inconsistent">‚ùå Test xatosi: ${error.message}</div>`;
            }
        }

        function analyzeConsistency() {
            const resultsContent = document.getElementById('results-content');
            
            if (testResults.length === 0) {
                resultsContent.innerHTML = '<div class="test-result inconsistent">‚ùå Test natijalari yo\'q</div>';
                return;
            }
            
            // Check if all results are identical
            const firstResult = testResults[0];
            let isConsistent = true;
            let consistencyDetails = '';
            
            // Compare extracted answers
            const answerConsistency = testResults.every(result => 
                JSON.stringify(result.extractedAnswers) === JSON.stringify(firstResult.extractedAnswers)
            );
            
            // Compare scores
            const scoreConsistency = testResults.every(result => 
                result.totalScore === firstResult.totalScore &&
                result.correctAnswers === firstResult.correctAnswers &&
                result.wrongAnswers === firstResult.wrongAnswers &&
                result.blankAnswers === firstResult.blankAnswers
            );
            
            isConsistent = answerConsistency && scoreConsistency;
            
            // Generate detailed comparison
            let comparisonHTML = '<div class="grid">';
            
            testResults.forEach((result, index) => {
                const isMatch = JSON.stringify(result.extractedAnswers) === JSON.stringify(firstResult.extractedAnswers);
                comparisonHTML += `
                    <div class="comparison">
                        <h4>Test ${index + 1} ${isMatch ? '‚úÖ' : '‚ùå'}</h4>
                        <p><strong>Ball:</strong> ${result.totalScore}/20</p>
                        <p><strong>To'g'ri:</strong> ${result.correctAnswers}</p>
                        <p><strong>Noto'g'ri:</strong> ${result.wrongAnswers}</p>
                        <p><strong>Bo'sh:</strong> ${result.blankAnswers}</p>
                        <p><strong>Ishonch:</strong> ${Math.round(result.confidence * 100)}%</p>
                        <div class="answer-grid">
                            ${result.extractedAnswers.map((ans, i) => {
                                const expectedAns = expectedStudentAnswers[i] || 'BLANK';
                                const isCorrect = ans === expectedAns;
                                return `<div class="answer-cell ${isCorrect ? 'match' : 'mismatch'}" title="Q${i+1}: AI=${ans}, Expected=${expectedAns}">${ans || 'BLANK'}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            comparisonHTML += '</div>';
            
            // Summary
            const summaryHTML = `
                <div class="test-result ${isConsistent ? 'consistent' : 'inconsistent'}">
                    <h3>${isConsistent ? '‚úÖ AI CONSISTENT' : '‚ùå AI INCONSISTENT'}</h3>
                    <p><strong>Test soni:</strong> ${testResults.length}</p>
                    <p><strong>Javoblar consistency:</strong> ${answerConsistency ? '‚úÖ Bir xil' : '‚ùå Turlicha'}</p>
                    <p><strong>Ballar consistency:</strong> ${scoreConsistency ? '‚úÖ Bir xil' : '‚ùå Turlicha'}</p>
                    <p><strong>Umumiy natija:</strong> ${isConsistent ? 'AI har doim bir xil natija beradi' : 'AI turli natijalar beradi'}</p>
                </div>
            `;
            
            resultsContent.innerHTML = summaryHTML + comparisonHTML;
        }

        async function runAccuracyTest() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '<div style="text-align: center;">üéØ AI Accuracy Test ishlamoqda...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const result = await runSingleAITest(1);
                
                // Compare with expected answers
                let correctDetections = 0;
                let detailedComparison = '';
                
                for (let i = 0; i < 20; i++) {
                    const aiAnswer = result.extractedAnswers[i] || 'BLANK';
                    const expectedAnswer = expectedStudentAnswers[i] || 'BLANK';
                    const isCorrect = aiAnswer === expectedAnswer;
                    
                    if (isCorrect) correctDetections++;
                    
                    detailedComparison += `
                        <div class="answer-cell ${isCorrect ? 'match' : 'mismatch'}">
                            Q${i+1}: AI=${aiAnswer}, Expected=${expectedAnswer} ${isCorrect ? '‚úÖ' : '‚ùå'}
                        </div>
                    `;
                }
                
                const accuracy = (correctDetections / 20) * 100;
                
                const accuracyHTML = `
                    <div class="test-result ${accuracy >= 90 ? 'consistent' : 'inconsistent'}">
                        <h3>üéØ AI Accuracy Test Natijasi</h3>
                        <p><strong>Aniqlik:</strong> ${accuracy.toFixed(1)}% (${correctDetections}/20)</p>
                        <p><strong>AI Ball:</strong> ${result.totalScore}/20</p>
                        <p><strong>Kutilgan Ball:</strong> Manual calculation needed</p>
                        <p><strong>Ishonch:</strong> ${Math.round(result.confidence * 100)}%</p>
                        <p><strong>Natija:</strong> ${accuracy >= 90 ? '‚úÖ Yuqori aniqlik' : '‚ùå Past aniqlik'}</p>
                    </div>
                    <div class="comparison">
                        <h4>Batafsil Taqqoslash</h4>
                        <div class="answer-grid">
                            ${detailedComparison}
                        </div>
                    </div>
                `;
                
                resultsContent.innerHTML = accuracyHTML;
                
            } catch (error) {
                console.error('Accuracy test error:', error);
                resultsContent.innerHTML = `<div class="test-result inconsistent">‚ùå Test xatosi: ${error.message}</div>`;
            }
        }

        function clearResults() {
            document.getElementById('results').style.display = 'none';
            testResults = [];
        }
    </script>
</body>
</html>